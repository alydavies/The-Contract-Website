commands:
  setvars:
    command: /opt/elasticbeanstalk/bin/get-config environment | jq -r 'to_entries | .[] | "export \(.key)=\"\(.value)\""' > /etc/profile.d/sh.local
option_settings:
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: hgapp.settings
container_commands:
  01_memcache:
    command: "memcached -m 300 -I 2m -d -u memcached"
  02_postgres_activate:
    command: "source /var/app/venv/*/bin/activate && sudo amazon-linux-extras enable postgresql10"
  03_postgres_install:
    command: "source /var/app/venv/*/bin/activate && sudo yum install -y postgresql-devel"
  04_install_python_reqs:
    command: "source /var/app/venv/*/bin/activate && pip install -r /var/app/staging/requirements.txt"
  05_install_node_npm:
    command: "sudo curl --silent --location https://rpm.nodesource.com/setup_10.x | sudo bash -"
  06_update_node_npm:
    command: "sudo yum -y install nodejs"
  07_install_npm_reqs:
    command: "npm --prefix /var/app/staging/ install"
  08_run_npm_build:
    command: "npm --prefix /var/app/staging/ run build"
  09_makelog:
    command: "touch /var/app/staging/hgapp/APPNAME.log && chmod 777 /var/app/staging/hgapp/APPNAME.log"
  10_makelog2:
    command: "touch /var/app/staging/hgapp/contract-app.log && chmod 777 /var/app/staging/hgapp/contract-app.log"
  11_collectstatic:
    command: "source /var/app/venv/*/bin/activate && python /var/app/staging/manage.py collectstatic --noinput"
  12_migrate:
    command: "source /var/app/venv/*/bin/activate && python /var/app/staging/manage.py migrate --noinput"
    leader_only: true
  13_clear_sessions:
    command: "source /var/app/venv/*/bin/activate && python /var/app/staging/manage.py clearsessions"
    leader_only: true
